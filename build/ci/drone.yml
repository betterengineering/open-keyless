kind: pipeline
name: default

steps:
  - name: test
    image: golang:1.11
    environment:
      GO111MODULE: on
      AIRTABLE_API_KEY:
        from_secret: airtable_api_key
      AIRTABLE_BASE_ID:
        from_secret: airtable_base_id
    commands:
      - apt-get update && apt-get install -y libnfc-dev
      - make test-full

  - name: build
    image: golang:1.11
    environment:
      GO111MODULE: on
    commands:
      - make build

  - name: build debian package
    image: quay.io/lodge93/drone-fpm:latest
    settings:
      name: open-keyless-controller
      version: snapshot-${DRONE_COMMIT_SHA}
      input_type: dir
      output_type: deb
      architecture: armhf
      package: build/out/open-keyless-controller-snapshot-${DRONE_COMMIT_SHA}.deb
      deb_systemd: build/package/systemd/open-keyless-controller.service
      command_arguments: build/out/linux/arm/open-keyless-controller=/usr/local/bin/
